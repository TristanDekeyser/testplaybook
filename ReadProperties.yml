- name: Clone or pull GitHub repo and read variables
  hosts: localhost

  tasks:
    - name: Check if the repository exists
      stat:
        path: /tmp/client_configuration
      register: repo_exists

    - name: Clone the GitHub repository
      git:
        repo: "git@git.is4u.be:stage/stage-2025-ansible-tower/client-configurations.git"
        dest: /tmp/client_configuration
        version: main
      when: not repo_exists.stat.exists

    - name: Pull the latest changes if the repository exists
      git:
        repo: "git@git.is4u.be:stage/stage-2025-ansible-tower/client-configurations.git"
        dest: /tmp/client_configuration
        version: main
        update: yes
      when: repo_exists.stat.exists
      register: git_pull_result

    - name: Find all YAML files in DEV folder
      find:
        paths: /tmp/client_configuration/DEV
        patterns: "*.yml"
      register: yaml_files
      # when: git_pull_result.changed

    - name: Read and display variables from each YAML file
      debug:
        msg:
          - "File: {{ item.path }}"
          - "Client Name: {{ (lookup('file', item.path) | from_yaml).client_name | default('N/A') }}"
          - "Definition Name: {{ (lookup('file', item.path) | from_yaml).definition_name | default('N/A') }}"
          - "Company Name: {{ (lookup('file', item.path) | from_yaml).company_name | default('N/A') }}"
          - "Redirect URIs: {{ (lookup('file', item.path) | from_yaml).redirect_uri | default('N/A') }}"
          - "Client ID: {{ (lookup('file', item.path) | from_yaml).client_id | default('N/A') }}"
          - "Client Secret: {{ (lookup('file', item.path) | from_yaml).client_secret | default('N/A') }}"
          - "Require PKCE: {{ (lookup('file', item.path) | from_yaml).require_pkce | default('N/A') }}"
          - "Ext Properties: {{ (lookup('file', item.path) | from_yaml).extProperties | default('N/A') }}"
      loop: "{{ yaml_files.files }}"
      # when: git_pull_result.changed
