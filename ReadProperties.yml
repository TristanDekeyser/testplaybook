---
- name: Clone or pull GitHub repo and read variables
  hosts: localhost

  tasks:
    - name: Check if the repository exists
      stat:
        path: /tmp/client_configuration
      register: repo_exists

    - name: Clone the GitHub repository
      git:
        repo: "git@git.is4u.be:stage/stage-2025-ansible-tower/client-configurations.git"
        dest: /tmp/client_configuration
        version: main
      when: not repo_exists.stat.exists

    - name: Pull the latest changes if the repository exists
      command: git -C /tmp/client_configuration pull
      register: git_pull_result
      when: repo_exists.stat.exists
      changed_when: "'Already up to date.' not in git_pull_result.stdout"

    - name: Get list of created, updated, and deleted files (only if pull changed)
      command: git -C /tmp/client_configuration diff --name-status HEAD~1 HEAD
      register: git_diff_result
      when: git_pull_result.changed

    - name: Parse git diff output
      set_fact:
        created_files: "{{ git_diff_result.stdout_lines | select('search', '^A\\s+') | map('regex_replace', '^A\\s+', '') | list }}"
        updated_files: "{{ git_diff_result.stdout_lines | select('search', '^M\\s+') | map('regex_replace', '^M\\s+', '') | list }}"
        deleted_files: "{{ git_diff_result.stdout_lines | select('search', '^D\\s+') | map('regex_replace', '^D\\s+', '') | list }}"
      when: git_pull_result.changed

    - name: Display created, updated, and deleted files (only if pull changed)
      debug:
        msg: "{{ {'Created Files': created_files, 'Updated Files': updated_files, 'Deleted Files': deleted_files} }}"
      when: git_pull_result.changed

    - name: Initialize empty clients list
      set_fact:
        clients: []

    - name: Read and transform variables for updated and created files
      rename_vars:
        file_path: "/tmp/client_configuration/{{ item }}"
      register: transformed_clients
      loop: "{{ created_files + updated_files }}"
      when: git_pull_result.changed

    - name: Store transformed variables in clients list
      set_fact:
        clients: "{{ clients + [ {'file': item.item, 'vars': item.transformed_vars} ] }}"
      loop: "{{ transformed_clients.results }}"
      when: git_pull_result.changed

    - name: Display all transformed clients' information in pretty JSON
      debug:
        msg: "{{ clients }}"
      when: git_pull_result.changed

    # Sla de waarde van git_pull_result en clients op als globale variabele
    - name: Set fact for git_pull_result
      set_fact:
        global_git_pull_result: "{{ git_pull_result }}"

    - name: Set fact for clients
      set_fact:
        global_clients: "{{ clients }}"

- name: Voeg een OAuth-client toe aan IBM ISAM
  hosts: isam
  gather_facts: no

  tasks:
    - name: Add OAuth client based on the transformed variables
      ansible.builtin.include_role:
        name: ibm.isam.add_oauth_client
      vars:
        oauth_clients: "{{ global_clients }}"
      when: global_git_pull_result.changed
